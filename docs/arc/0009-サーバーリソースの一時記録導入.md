# ADR 9 : サーバーリソースの一時記録導入

<!-- ADR ナンバー : タイトル -->

## Status : 🟢 承認

<!--
※ここから選んでステータスの横に貼っ付ける
🟡提案
🟢承認
🔴廃止
-->

## Context

<!--
問題の背景や定義
事実だけを描く
-->

CPU 使用率やメモリ使用率を監視しておらず、障害対応の対策や今後のインフラ拡張を考えにくい

## Decision

<!-- 提案、すること -->

直近 30 分の CPU 使用率、メモリ使用率、ディスク使用率を取得できる仕組みを作る

## Consequences

<!-- Decisionによって得られるもの -->

### Pros

-   グラフとして把握できる
-   今後のインフラ整備の参考値が取れる
-   障害対応の対策がしやすくなる

### Cons

-   常に取得書き込みの処理が走る  
    RDB でなくインラインメモリ(redis)を用いるようにはしているが、実際運用次第で SaaS への移行も必要かも
-   メモリの圧迫を招く  
    30 分で消えるように expire を付けている
-   30 分分のデータ量を response に渡すことによる速度面の懸念  
    速度を重視するために文字列のまま返すようにしている
-   サーバーの状況が一部表に公開される  
    これに関しては misskey.io が公開しながらの運用で成り立っているという観点から問題ないと判断した(あくまで使用率についてしか表に出さないが、DDoS の指標になりうる可能性がある)

## Notes

## References
